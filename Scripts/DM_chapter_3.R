#########################################################################
# ??????? ?.?., ????????? ?.?. (2017) ?????????????, ????????? ? ?????? ????????? Data Mining 
# ? ?????????????? R. (????? ???????: http://www.ievbras.ru/ecostat/Kiril/R/DM )
#########################################################################
#########################################################################
# ????? 3. ????? CARET  - ?????????? ?????????? ?????????????? ??????? ? R 
#########################################################################

#  3.2. ??????????? ? ???????? "????????" ???????????
#-----------------------------------------------------------------------
library(caret)
data(GermanCredit)
(u <-unique(GermanCredit$ResidenceDuration))
# ???? ?????????? ????????:
length(u)/nrow(GermanCredit)
(t<- sort(table(GermanCredit$ResidenceDuration), 
                 decreasing = TRUE))
t[1]/t[2]
# ???????? ????? ?????? ??? ??????? ? ???????? Class:
gcred = GermanCredit[, -10]
# ??????? nearZeroVar() ????????? ?????? ??????? ??????????,
# ?????????? ???????????? ??????????:
(nz = nearZeroVar(gcred))
print("????? ???? ??????????:") ; names(gcred)[nz]
# ??????? ?????????? ? ???????????? ??????????:
gcred.clean = gcred[, -nz]

a <- apply(gcred.clean, 2, max)
ab <- names(a[a==1])
gcred.bin <- gcred.clean[,ab]
head(gcred.bin)
m <-glm(y~., gcred.bin, family=binomial)
summary(m)
library("MASS") 
Fac.lda <- lda(gcred.bin, grouping = y) 


# ?????????? ???????? ????????????? ???????
top.mat <- function(X, level=0.45, N=10, values=TRUE) {
X.nam <- row.names(X)
X.tri <- as.vector(lower.tri(X))
X.rep.g <- rep(X.nam, length(X.nam))[X.tri]
X.rep.e <- rep(X.nam, each=length(X.nam))[X.tri]
X.vec <- as.vector(X)[X.tri]
X.df <- data.frame(Var1=X.rep.g, Var2=X.rep.e, Value=X.vec)
{if (values)
    {X.df <- X.df[abs(X.df$Value) >= level, ]
    X.df <- X.df[order(-abs(X.df$Value)), ]}
else
    {X.df <- X.df[order(-abs(X.df$Value)), ]
    X.df <- X.df[1:N, ]}}
row.names(X.df) <- seq(1, along=X.df$Value)
return(X.df)
}
top.mat(cor(gcred.clean))
# ??????? findCorrelation() ????????? ?????? 
# ??????? ?????????? ? ??????? ???????????:
(highCor = findCorrelation(cor(gcred.clean), cutoff = 0.75))
print("????? ???? ??????????:")
names( gcred.clean)[highCor]
# ??????? ??? ??????????:
gcred.clean =  gcred.clean[, -highCor]
(linCombo <- findLinearCombos(gcred.clean))
# ??????? ??? ??????????:
gcred.clean =  gcred.clean[, -linCombo$remove]
dim(gcred.clean)


#-----------------------------------------------------------------------
# 3.3. ?????????????: ?????????????? ? ????????? ????????????? ??????????
#-----------------------------------------------------------------------
data(GermanCredit)
TransPred <- c("Duration","Amount","Age")
preVar <- preProcess(GermanCredit[,TransPred])
TransVar = predict(preVar, GermanCredit[,TransPred])
print("?? ??????????????:")
summary(GermanCredit[,TransPred]) 
print("????? ??????????????:")
summary(TransVar) 
# ??? ?????????????, ?????????? ??????????
GermanCredit[,TransPred] <- TransVar

preBox <- preProcess(GermanCredit[,TransPred],
             method="BoxCox")
BoxVar <- predict(preBox,GermanCredit[,TransPred]) 
y <- factor(GermanCredit$Class)
trellis.par.set(theme = col.whitebg(), warn = FALSE)
featurePlot(GermanCredit$Amount, y, "density", 
          labels = c("Amount",""))
featurePlot(BoxVar[,2], y, "density", 
          labels = c("Box-Amount",""))

y <- factor(GermanCredit$Class)
gcred = GermanCredit[, -10]
nz = nearZeroVar(gcred)
gcred.clean = gcred[, -nz]
highCor = findCorrelation(cor(gcred.clean), cutoff = 0.75)
gcred.clean =  gcred.clean[, -highCor]
linCombo <- findLinearCombos(gcred.clean)
gcred.clean =  gcred.clean[, -linCombo$remove]
dim(gcred.clean)

library(vegan)
mod.pca <- rda(gcred.clean, scale=TRUE) 
ev <- mod.pca$CA$eig 
# ??????????? ???????? ???????-????????
barplot(ev, col="bisque", las=2)
abline(h=mean(ev), col="red") 
legend("topright", "??????? ??????????? ????????", 
             lwd=1, col=2, bty="n")
c(length(ev[ev > mean(ev)]),sum(ev[ev > mean(ev)])/sum(ev)) 

prePCA <- preProcess(gcred.clean, 
          method= c("center", "scale", "pca"), pcaComp=19)
gcred.pca <- predict(prePCA,gcred.clean)

train.index <- createDataPartition(y, p = .8, times = 100)
trControl = trainControl(method="LGOCV", index = train.index)
print('?????? ?? ??????????? ???????????')
modNat <- train(gcred.clean, y, "glm", 
        family=binomial, trControl = trControl)
print('?????? ?? ??????? ???????????')
modPCA <- train(gcred.pca, y, "glm", 
        family=binomial, trControl = trControl) 

plot(varImp(modNat, scale = FALSE))

#-----------------------------------------------------------------------
#  3.4. ?????????? ??????????? ???????? ? ??????
#-----------------------------------------------------------------------
library(DMwR)
library(ggplot2)
summary(algae) # ????? ?? ??????????
ggplot(data=algae[!is.na(algae$mnO2),], aes(speed , mnO2)) + 
       geom_violin(aes(fill = speed), trim = FALSE, 
       alpha = 0.3) + 
       geom_boxplot(aes(fill = speed), width = 0.2,
       outlier.colour = NA) + 
       theme(legend.position = "NA")

qplot(PO4, a1, data = algae[!is.na(algae$PO4), ]) +
      facet_grid(facets = ~ season)+
      geom_smooth(color="red", se = FALSE) 

# ????? ????? ? ???????????? ??????????
nrow(algae[!complete.cases(algae),])
# ?? ????????
algae <- na.omit(algae)

data(algae)
manyNAs(algae, 0.2)
algae <- algae[-manyNAs(algae, 0.2), ]

data(algae)
ind<- apply(algae, 1, function(x) sum(is.na(x))) > 0
algae[ind, 4:11]

# ?????????????? ??????????? ???????? ?????????
library(caret)
pPmI <- preProcess(algae[, 4:11], method = 'medianImpute')
algae[, 4:11] <- predict(pPmI, algae[, 4:11])
(Imp.Med <- algae[ind, 4:11])

data(algae)
lm(PO4 ~ oPO4, data = algae)
# ???????  ?????? ???????? PO4 ? ??????????? ?? ?PO4 
fillPO4 <- function(oP) {if (is.na(oP)) return(NA)
      else return(42.897 + 1.293 * oP)
}
# ?????????????? ??????????? ???????? PO4
algae[is.na(algae$PO4), 'PO4'] <- 
   sapply(algae[is.na(algae$PO4), 'oPO4'], fillPO4)
algae[ind, 10]

# ?????????????? ??????????? ???????? ?????????
data(algae)
pPbI <- preProcess(algae[, 4:11], method = 'bagImpute')
algae[, 4:11] <- predict(pPbI, algae[, 4:11])
Imp.Bag <- algae[ind, 4:11]

# ?????????????? ??????????? ???????? k-?????????? ????????
data(algae)
pPkI <- preProcess(algae[, 4:11], method = 'knnImpute')
alg.stand <- predict(pPkI, algae[, 4:11])

m <- pPkI$mean
sd <- pPkI$std
algae[, 4:11] <- t(apply(alg.stand, 1, 
                    function (r) m + r * sd))
(Imp.Knn <- algae[ind, 4:11])

ImpVal <- rbind(Imp.Med, Imp.Knn)
ImpVal <- rbind(ImpVal, Imp.Bag)
Imp.Metod <- as.factor(c(rep("Med", 16), rep("Knn", 16), rep("Bag", 16)))

library(vegan)
Imp.M <- rda(ImpVal ~ Imp.Metod, ImpVal)
plot(Imp.M, display = "sites", type = "p")
ordihull(Imp.M, Imp.Metod, draw = "polygon", alpha = 67, 
         lty = 2, col = c(1, 2, 3), label = TRUE)

#-----------------------------------------------------------------------
#  3.5. ??????? train() ?????? caret
#-----------------------------------------------------------------------
library(caret)
ls(getModelInfo(model = "lm"))
modelLookup("lm")
modelLookup("rpart")

library(DAAG)
data("fruitohms")
set.seed(123) 
max.poly <- 7
degree <- 1:max.poly
RSquared <- rep(0,max.poly)
RMSE <- rep(0,max.poly)
# ???????? 10-??????? ????????????? ? 10 ?????????????
fitControl <- trainControl(method = "repeatedcv",
          number = 10,repeats = 10)
# ????????? ?????? ??? ????????? ????????
for ( d in degree)  {
  LinearRegressor <- train( ohms ~ poly(juice, d),
     data = fruitohms,
     method = "lm",trControl =fitControl)
     RSquared[d] <- LinearRegressor$results$Rsquared
     RMSE[d]<- LinearRegressor$results$RMSE
}
library(ggplot2)
Degree.RegParams = data.frame(degree,RSquared,RMSE)
ggplot(aes(x = degree,y = RSquared),
      data = Degree.RegParams) + geom_line()
ggplot(aes(x = degree,y = RMSE),
      data = Degree.RegParams) + geom_line()
Poly5 <- train(ohms ~ poly(juice,5), data = fruitohms,
      method = "lm")
summary(Poly5$finalModel)
summary(lm(ohms ~ poly(juice,5), data = fruitohms))
Poly5



